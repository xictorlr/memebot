name: Telegram Trading Alerts
on:
  schedule:
    # Ejecutar cada 5 minutos (mÃ¡s confiable)
    - cron: '*/5 * * * *'
  
  # Permitir ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  send-alerts:
    runs-on: ubuntu-latest
    
    # Timeout para evitar ejecuciones colgadas
    timeout-minutes: 10
    
    steps:
    - name: Debug Info
      run: |
        echo "ğŸ• Ejecutando anÃ¡lisis automÃ¡tico a las $(date)"
        echo "ğŸ”— Supabase URL: ${{ secrets.SUPABASE_URL }}"
        echo "ğŸ”‘ Anon Key configurado: ${{ secrets.SUPABASE_ANON_KEY != '' }}"
        
    - name: Send Telegram Trading Alert
      shell: bash
      run: |
        set -e  # Activar exit on error para mejor debugging
        
        echo "ğŸ¤– Iniciando anÃ¡lisis automÃ¡tico de trading..."
        
        # Verificar que las variables estÃ©n configuradas
        if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
          echo "âŒ ERROR: SUPABASE_URL no estÃ¡ configurado en secrets"
          exit 1
        fi
        
        if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
          echo "âŒ ERROR: SUPABASE_ANON_KEY no estÃ¡ configurado en secrets"
          exit 1
        fi
        
        # Llamar a la Edge Function de Supabase
        echo "ğŸ“¡ Llamando a Edge Function..."
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "${{ secrets.SUPABASE_URL }}/functions/v1/trading-analyzer" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Content-Type: application/json" \
          --max-time 300)
        
        curl_exit_code=$?
        
        # Verificar si curl funcionÃ³
        if [ $curl_exit_code -ne 0 ]; then
          echo "âŒ Error en curl (cÃ³digo: $curl_exit_code)"
          exit 1
        fi
        
        # Separar el cÃ³digo de estado HTTP del cuerpo de la respuesta
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | head -n -1)
        
        echo "ğŸ“Š HTTP Status: $http_code"
        echo "ğŸ“Š Respuesta del anÃ¡lisis:"
        echo "$response_body"
        
        # Verificar si la respuesta HTTP fue exitosa
        if [[ "$http_code" == "200" ]]; then
          echo "âœ… HTTP request successful"
          
          # Verificar si el anÃ¡lisis fue exitoso
          if echo "$response_body" | grep -q '"success":true'; then
            echo "âœ… AnÃ¡lisis completado exitosamente"
            
            # Contar seÃ±ales si existen
            if echo "$response_body" | grep -q '"signals"'; then
              signals_count=$(echo "$response_body" | jq -r '.signals | length' 2>/dev/null || echo "N/A")
              echo "ğŸ“ˆ SeÃ±ales encontradas: $signals_count"
            else
              echo "ğŸ“ˆ No se encontraron seÃ±ales en esta ejecuciÃ³n"
            fi
            
            echo "ğŸ¯ AnÃ¡lisis completado con Ã©xito"
            exit 0
          else
            echo "âŒ AnÃ¡lisis fallÃ³"
            echo "$response_body"
            exit 1
          fi
        else
          echo "âŒ Error HTTP: $http_code"
          echo "Response: $response_body"
          exit 1
        fi
