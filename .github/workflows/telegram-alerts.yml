name: Telegram Trading Alerts
on:
  schedule:
    # Ejecutar cada 5 minutos
    - cron: '*/5 * * * *'
  
  # Permitir ejecuci√≥n manual
  workflow_dispatch:

jobs:
  send-alerts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Telegram Trading Alert
      shell: bash
      run: |
        set +e  # Desactivar exit on error
        
        echo "ü§ñ Ejecutando an√°lisis autom√°tico de trading..."
        
        # Llamar a la Edge Function de Supabase
        response=$(curl -s -w "%{http_code}" -X POST \
          "${{ secrets.SUPABASE_URL }}/functions/v1/trading-analyzer" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
          -H "Content-Type: application/json")
        
        curl_exit_code=$?
        
        # Verificar si curl funcion√≥
        if [ $curl_exit_code -ne 0 ]; then
          echo "‚ùå Error en curl (c√≥digo: $curl_exit_code)"
          echo "üîÑ Reintentando en la pr√≥xima ejecuci√≥n..."
          exit 0  # No fallar el workflow
        fi
        
        # Separar el c√≥digo de estado HTTP del cuerpo de la respuesta
        if [ ${#response} -ge 3 ]; then
          http_code="${response: -3}"
          response_body="${response%???}"
        else
          echo "‚ùå Respuesta muy corta o vac√≠a"
          echo "Response: $response"
          exit 0
        fi
        
        echo "üìä HTTP Status: $http_code"
        echo "üìä Respuesta del an√°lisis:"
        echo "$response_body"
        
        # Verificar si la respuesta HTTP fue exitosa
        if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
          echo "‚úÖ HTTP request successful"
          
          # Verificar si el an√°lisis fue exitoso
          if echo "$response_body" | grep -q '"success":true'; then
            echo "‚úÖ An√°lisis completado exitosamente"
            
            # Contar se√±ales si existen
            if echo "$response_body" | grep -q '"signals"'; then
              signals_count=$(echo "$response_body" | grep -o '"signals":\[[^]]*\]' | grep -o '{"' | wc -l)
              echo "üìà Se√±ales encontradas: $signals_count"
            else
              echo "üìà No se encontraron se√±ales en esta ejecuci√≥n"
            fi
          else
            echo "‚ö†Ô∏è An√°lisis completado pero con errores"
            echo "$response_body"
          fi
        else
          echo "‚ùå Error HTTP: $http_code"
          echo "Response: $response_body"
          echo "‚ö†Ô∏è Continuando... (errores de API son temporales)"
        fi
        
        echo "üîÑ Workflow completado - pr√≥xima ejecuci√≥n en 5 minutos"
        exit 0  # Siempre terminar con √©xito
